<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业八字命盘查询系统 v2.0 - 完整功能版</title>
<style>
        /* 全局重置与基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        /* 表单区域样式 */
        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn-calculate {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        /* 加载与错误提示 */
        .loading, .error-message {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading {
            color: #3498db;
        }
        
        .error-message {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 结果区域 */
        .result-section {
            display: none;
        }
        
        /* 选项卡样式 */
        .tab-container {
            margin-top: 30px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            background: #e2e8f0;
        }
        
        .tab-button.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .card h3 {
            color: #34495e;
            margin: 25px 0 15px 0;
            font-size: 18px;
        }
        
        /* 八字表格样式 */
        .bazi-table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .bazi-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .bazi-table th, .bazi-table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .bazi-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .bazi-table .pillar-row {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .ganzhi-cell {
            font-size: 18px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .nayin-cell {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        /* 五行显示样式 */
        .element-display {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .element-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            min-width: 120px;
        }
        
        .element-item .name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .element-item .percentage {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .element-item .score {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        /* 格局卡片样式 */
        .pattern-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .pattern-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
        }
        
        .pattern-card .title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .pattern-card .score {
            float: right;
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .pattern-card .type {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .pattern-card .desc {
            color: #34495e;
            line-height: 1.6;
            font-size: 14px;
        }
        
        /* 神煞卡片样式 */
        .shensha-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .shensha-card {
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .shensha-card .name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .shensha-card .type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .shensha-card .desc {
            font-size: 13px;
            line-height: 1.5;
            color: #555;
        }
        
        .shensha-ji .name { color: #2ecc71; }
        .shensha-ji .type { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        
        .shensha-xiong .name { color: #e74c3c; }
        .shensha-xiong .type { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        
        .shensha-ban .name { color: #f1c40f; }
        .shensha-ban .type { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
        
        /* 大运流年容器 */
        .yun-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .yun-stage {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .yun-stage .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .yun-stage .title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .yun-stage .age {
            font-size: 14px;
            color: #3498db;
            font-weight: 600;
        }
        
        .yun-stage .details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-item .detail-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .detail-item .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .tab-buttons {
                justify-content: center;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 12px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .element-display {
                flex-direction: column;
            }
            
            .yun-stage .details {
                grid-template-columns: 1fr;
            }
        }
        
        /* 流年年份批注卡片样式 */
        .future-liunian-card {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, rgba(52, 152, 219, 0.02) 100%);
            border: 1px solid rgba(52, 152, 219, 0.2);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .future-liunian-card:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%);
            transform: translateY(-3px);
        }
        
        .future-liunian-card h4 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .future-liunian-card h4 i {
            margin-right: 8px;
        }
        
        .future-liunian-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            font-size: 14px;
            line-height: 1.8;
        }
        
        .future-liunian-content strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .future-liunian-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 15px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }
        
        .future-liunian-score .label {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .future-liunian-score .value {
            font-size: 24px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        /* 分数显示样式 */
        .score-display {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .score-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .score-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .score-item .name {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .score-item .value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }
        
        .score-item .grade {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        /* 详细分析条款 */
        .analysis-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #9b59b6;
        }
        
        .analysis-item h4 {
            color: #9b59b6;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .analysis-item p {
            color: #34495e;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .analysis-item .score-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .analysis-item .detail-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .analysis-item .detail-list li {
            color: #34495e;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .analysis-item .detail-list li strong {
            color: #2c3e50;
        }
        
        /* 流年分析表格 */
        .liunian-analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .liunian-analysis-table th,
        .liunian-analysis-table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .liunian-analysis-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }
        
        .liunian-analysis-table tr:hover {
            background: #f8f9fa;
        }
        
        .liunian-analysis-table .year-cell {
            font-weight: 600;
            color: #3498db;
            background: #f8f9fa;
        }
        
        .liunian-analysis-table .advice-cell {
            text-align: left;
            color: #34495e;
            line-height: 1.6;
        }
        
        .liunian-analysis-table .score-cell {
            font-weight: bold;
            color: #e74c3c;
        }
        
        /* 年度批注导航 */
        .year-annotation-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .year-annotation-nav .nav-item {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            color: #7f8c8d;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .year-annotation-nav .nav-item:hover {
            border-color: #3498db;
            color: #3498db;
            transform: translateY(-2px);
        }
        
        .year-annotation-nav .nav-item.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* 年度批注内容区域 */
        .year-annotation-content {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .year-annotation-content.active {
            display: block;
        }
        
        .year-annotation-content h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .year-annotation-content .summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .year-annotation-content .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .analysis-card .title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .analysis-card .content {
            color: #34495e;
            line-height: 1.7;
            font-size: 14px;
        }
        
        .analysis-card .score-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #3498db;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .analysis-card .caution {
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            color: #e74c3c;
        }
        
        .analysis-card .advice {
            background: rgba(46, 204, 113, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            color: #2ecc71;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>专业八字命盘查询系统 v2.0</h1>
        <div class="subtitle">基于完整八字算法库，包含精确节气计算、30+种格局分析、30+种神煞系统、大运流年等完整功能</div>
        
        <!-- 输入表单区域 -->
        <div class="form-section">
            <div class="form-row">
                <div class="form-group">
                    <label for="birth-date"><i class="fas fa-calendar-alt"></i> 出生日期</label>
                    <input type="date" id="birth-date" class="form-control" required value="1990-06-15">
                </div>
                <div class="form-group">
                    <label for="birth-hour"><i class="fas fa-clock"></i> 出生时辰</label>
                    <select id="birth-hour" class="form-control" required>
                        <option value="0">0点 (子时)</option>
                        <option value="1">1点 (丑时)</option>
                        <option value="2">2点 (丑时)</option>
                        <option value="3">3点 (寅时)</option>
                        <option value="4">4点 (寅时)</option>
                        <option value="5">5点 (卯时)</option>
                        <option value="6">6点 (卯时)</option>
                        <option value="7">7点 (辰时)</option>
                        <option value="8">8点 (辰时)</option>
                        <option value="9">9点 (巳时)</option>
                        <option value="10">10点 (巳时)</option>
                        <option value="11">11点 (午时)</option>
                        <option value="12" selected>12点 (午时)</option>
                        <option value="13">13点 (未时)</option>
                        <option value="14">14点 (未时)</option>
                        <option value="15">15点 (申时)</option>
                        <option value="16">16点 (申时)</option>
                        <option value="17">17点 (酉时)</option>
                        <option value="18">18点 (酉时)</option>
                        <option value="19">19点 (戌时)</option>
                        <option value="20">20点 (戌时)</option>
                        <option value="21">21点 (亥时)</option>
                        <option value="22">22点 (亥时)</option>
                        <option value="23">23点 (子时)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="city-select"><i class="fas fa-city"></i> 所在城市（自动匹配经度）</label>
                    <select id="city-select" class="form-control" required>
                        <option value="">-- 请选择城市 --</option>
                        <option value="116.40,39.90" selected>北京</option>
                        <option value="121.48,31.22">上海</option>
                        <option value="113.23,23.16">广州</option>
                        <option value="114.07,22.62">深圳</option>
                        <option value="117.20,39.13">天津</option>
                        <option value="118.78,32.04">南京</option>
                        <option value="120.19,30.26">杭州</option>
                        <option value="119.90,32.05">苏州</option>
                        <option value="120.62,31.32">无锡</option>
                        <option value="121.50,25.05">台北</option>
                        <option value="110.35,20.02">海口</option>
                        <option value="108.33,22.80">南宁</option>
                        <option value="113.00,28.21">长沙</option>
                        <option value="114.31,30.52">武汉</option>
                        <option value="116.98,36.67">济南</option>
                        <option value="119.30,26.08">福州</option>
                        <option value="120.68,28.01">温州</option>
                        <option value="121.30,28.64">宁波</option>
                        <option value="115.89,28.68">南昌</option>
                        <option value="112.54,37.87">太原</option>
                        <option value="113.65,34.76">郑州</option>
                        <option value="106.55,29.56">重庆</option>
                        <option value="104.06,30.67">成都</option>
                        <option value="108.95,34.27">西安</option>
                        <option value="103.82,36.05">兰州</option>
                        <option value="87.68,43.77">乌鲁木齐</option>
                        <option value="91.11,29.65">拉萨</option>
                        <option value="102.73,25.04">昆明</option>
                        <option value="106.71,26.57">贵阳</option>
                        <option value="126.63,45.75">哈尔滨</option>
                        <option value="123.38,41.80">沈阳</option>
                        <option value="125.32,43.88">长春</option>
                        <option value="custom">手动输入经度...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="longitude-input"><i class="fas fa-globe-asia"></i> 经度（手动输入）</label>
                    <input type="number" id="longitude-input" class="form-control" step="0.01" value="116.40" placeholder="例如：116.40（北京）" readonly>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="gender-select"><i class="fas fa-user"></i> 性别</label>
                    <select id="gender-select" class="form-control" required>
                        <option value="male" selected>男</option>
                        <option value="female">女</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-calculate" id="calculate-btn">
                <i class="fas fa-calculator"></i> 计算完整八字命盘
            </button>
        </div>
        
        <!-- 加载提示 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>正在解析八字命盘，请稍候...</p>
        </div>
        
        <!-- 错误提示 -->
        <div class="error-message" id="error">
            <p><i class="fas fa-exclamation-triangle"></i> 计算出错，请检查输入信息是否正确！</p>
        </div>
        
        <!-- 结果展示区域 -->
        <div class="result-section" id="result">
            <!-- 选项卡导航 -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="tab1">八字命盘</button>
                    <button class="tab-button" data-tab="tab2">格局分析</button>
                    <button class="tab-button" data-tab="tab3">神煞系统</button>
                    <button class="tab-button" data-tab="tab4">大运流年</button>
                    <button class="tab-button" data-tab="tab5">综合建议</button>
                    <button class="tab-button" data-tab="tab6" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white;">紫微扩展</button>
                </div>
                
                <!-- 八字命盘选项卡 -->
                <div class="tab-content active" id="tab1">
                    <div class="card">
                        <h2><i class="fas fa-star"></i> 基础八字信息</h2>
                        
                        <!-- 八字表格 -->
                        <div class="bazi-table-container">
                            <table class="bazi-table">
                                <thead>
                                    <tr>
                                        <th>四柱</th>
                                        <th>年柱</th>
                                        <th>月柱</th>
                                        <th>日柱</th>
                                        <th>时柱</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="pillar-row">
                                        <td>干支</td>
                                        <td class="ganzhi-cell" id="pillar-year"></td>
                                        <td class="ganzhi-cell" id="pillar-month"></td>
                                        <td class="ganzhi-cell" id="pillar-day"></td>
                                        <td class="ganzhi-cell" id="pillar-hour"></td>
                                    </tr>
                                    <tr>
                                        <td>藏干</td>
                                        <td id="canggan-year"></td>
                                        <td id="canggan-month"></td>
                                        <td id="canggan-day"></td>
                                        <td id="canggan-hour"></td>
                                    </tr>
                                    <tr>
                                        <td>纳音</td>
                                        <td class="nayin-cell" id="nayin-year"></td>
                                        <td class="nayin-cell" id="nayin-month"></td>
                                        <td class="nayin-cell" id="nayin-day"></td>
                                        <td class="nayin-cell" id="nayin-hour"></td>
                                    </tr>
                                    <tr>
                                        <td>十神</td>
                                        <td id="shishen-year"></td>
                                        <td id="shishen-month"></td>
                                        <td id="shishen-day"></td>
                                        <td id="shishen-hour"></td>
                                    </tr>
                                    <tr>
                                        <td>地势</td>
                                        <td id="dishi-year"></td>
                                        <td id="dishi-month"></td>
                                        <td id="dishi-day"></td>
                                        <td id="dishi-hour"></td>
                                    </tr>
                                    <tr>
                                        <td>空亡</td>
                                        <td id="kongwang-year"></td>
                                        <td id="kongwang-month"></td>
                                        <td id="kongwang-day"></td>
                                        <td id="kongwang-hour"></td>
                                    </tr>
                                    <tr>
                                        <td>神煞</td>
                                        <td id="shensha-year" style="white-space: pre-line; line-height: 1.6; padding: 10px;"></td>
                                        <td id="shensha-month" style="white-space: pre-line; line-height: 1.6; padding: 10px;"></td>
                                        <td id="shensha-day" style="white-space: pre-line; line-height: 1.6; padding: 10px;"></td>
                                        <td id="shensha-hour" style="white-space: pre-line; line-height: 1.6; padding: 10px;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 五行分布 -->
                        <h3><i class="fas fa-chart-pie"></i> 五行分布与平衡</h3>
                        <div class="element-distribution">
                            <div class="element-item">
                                <strong>木</strong>
                                <div class="value" id="element-wood">0%</div>
                                <div class="score" id="score-wood">得分: 0</div>
                            </div>
                            <div class="element-item">
                                <strong>火</strong>
                                <div class="value" id="element-fire">0%</div>
                                <div class="score" id="score-fire">得分: 0</div>
                            </div>
                            <div class="element-item">
                                <strong>土</strong>
                                <div class="value" id="element-earth">0%</div>
                                <div class="score" id="score-earth">得分: 0</div>
                            </div>
                            <div class="element-item">
                                <strong>金</strong>
                                <div class="value" id="element-metal">0%</div>
                                <div class="score" id="score-metal">得分: 0</div>
                            </div>
                            <div class="element-item">
                                <strong>水</strong>
                                <div class="value" id="element-water">0%</div>
                                <div class="score" id="score-water">得分: 0</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px;">
                            <div style="flex: 1; min-width: 250px;">
                                <strong><i class="fas fa-user"></i> 日主信息</strong>
                                <div style="margin-top: 10px; font-size: 18px; color: #3498db;" id="day-master"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px;">
                                <strong><i class="fas fa-chart-line"></i> 综合评分</strong>
                                <div style="margin-top: 10px; font-size: 24px; color: #e74c3c; font-weight: bold;" id="total-score"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px;">
                                <strong><i class="fas fa-trophy"></i> 最强五行</strong>
                                <div style="margin-top: 10px; font-size: 18px; color: #2ecc71;" id="element-strongest"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px;">
                                <strong><i class="fas fa-heartbeat"></i> 最弱五行</strong>
                                <div style="margin-top: 10px; font-size: 18px; color: #e74c3c;" id="element-weakest"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 格局分析选项卡 -->
                <div class="tab-content" id="tab2">
                    <div class="card">
                        <h2><i class="fas fa-chess-board"></i> 命局格局分析</h2>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 25px 0;">
                            <div style="flex: 1; min-width: 250px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <strong><i class="fas fa-layer-group"></i> 格局等级</strong>
                                <div style="margin-top: 10px; font-size: 24px; color: #9b59b6;" id="pattern-level"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <strong><i class="fas fa-crown"></i> 主格局</strong>
                                <div style="margin-top: 10px; font-size: 20px; color: #3498db;" id="main-pattern"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <strong><i class="fas fa-star"></i> 格局数量</strong>
                                <div style="margin-top: 10px; font-size: 24px; color: #e74c3c;" id="pattern-count"></div>
                            </div>
                        </div>
                        
                        <h3><i class="fas fa-list"></i> 所有格局列表</h3>
                        <div id="pattern-container" class="pattern-cards"></div>
                        
                        <h3><i class="fas fa-balance-scale"></i> 喜用神与忌神</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 25px 0;">
                            <div style="flex: 1; min-width: 300px; background: rgba(46, 204, 113, 0.1); padding: 25px; border-radius: 12px; border-left: 5px solid #2ecc71;">
                                <strong style="color: #2ecc71; font-size: 18px;"><i class="fas fa-thumbs-up"></i> 喜用神</strong>
                                <div style="margin-top: 15px;" id="useful-gods"></div>
                            </div>
                            <div style="flex: 1; min-width: 300px; background: rgba(231, 76, 60, 0.1); padding: 25px; border-radius: 12px; border-left: 5px solid #e74c3c;">
                                <strong style="color: #e74c3c; font-size: 18px;"><i class="fas fa-thumbs-down"></i> 忌神</strong>
                                <div style="margin-top: 15px;" id="avoid-gods"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 神煞系统选项卡 -->
                <div class="tab-content" id="tab3">
                    <div class="card">
                        <h2><i class="fas fa-magic"></i> 神煞系统 (30+种)</h2>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin: 25px 0;">
                            <div style="flex: 1; min-width: 200px; text-align: center;">
                                <div style="font-size: 32px; color: #2ecc71;" id="shensha-ji-count">0</div>
                                <div style="color: #7f8c8d;">吉神</div>
                            </div>
                            <div style="flex: 1; min-width: 200px; text-align: center;">
                                <div style="font-size: 32px; color: #e74c3c;" id="shensha-xiong-count">0</div>
                                <div style="color: #7f8c8d;">凶神</div>
                            </div>
                            <div style="flex: 1; min-width: 200px; text-align: center;">
                                <div style="font-size: 32px; color: #f1c40f;" id="shensha-ban-count">0</div>
                                <div style="color: #7f8c8d;">中性神煞</div>
                            </div>
                            <div style="flex: 1; min-width: 200px; text-align: center;">
                                <div style="font-size: 32px; color: #3498db;" id="shensha-total-count">0</div>
                                <div style="color: #7f8c8d;">神煞总数</div>
                            </div>
                        </div>
                        
                        <h3><i class="fas fa-list-ul"></i> 神煞详细列表</h3>
                        <div id="shensha-container" class="shensha-container"></div>
                    </div>
                </div>
                
                <!-- 大运流年选项卡 -->
                <div class="tab-content" id="tab4">
                    <div class="card">
                        <h2><i class="fas fa-road"></i> 大运与流年分析</h2>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 25px 0;">
                            <div style="flex: 1; min-width: 250px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <strong><i class="fas fa-hourglass-start"></i> 起运岁数</strong>
                                <div style="margin-top: 10px; font-size: 22px; color: #3498db;" id="dayun-start"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <strong><i class="fas fa-arrows-alt-h"></i> 排盘方向</strong>
                                <div style="margin-top: 10px; font-size: 22px; color: #9b59b6;" id="dayun-direction"></div>
                            </div>
                            <div style="flex: 1; min-width: 250px; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <strong><i class="fas fa-calendar"></i> 起运年份</strong>
                                <div style="margin-top: 10px; font-size: 22px; color: #e74c3c;" id="dayun-year"></div>
                            </div>
                        </div>
                        
                        <h3><i class="fas fa-stairs"></i> 大运详细解析 (10步运)</h3>
                        <div id="dayun-container" class="yun-container"></div>
                        
                        <h3><i class="fas fa-calendar-alt"></i> 未来三年流年</h3>
                        <div id="liunian-container" class="yun-container"></div>
                        
                        <h3><i class="fas fa-chart-line"></i> 流年综合分析</h3>
                        <div class="liunian-analysis-table-container">
                            <table class="liunian-analysis-table">
                                <thead>
                                    <tr>
                                        <th>年份</th>
                                        <th>流年</th>
                                        <th>十神</th>
                                        <th>冲合</th>
                                        <th>神煞</th>
                                        <th>综合评分</th>
                                        <th>流年批注</th>
                                    </tr>
                                </thead>
                                <tbody id="liunian-analysis-tbody">
                                    <tr>
                                        <td colspan="7"><span style="color: #7f8c8d;"><i class="fas fa-spinner fa-spin"></i> 正在计算流年分析...</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 综合建议选项卡 -->
                <div class="tab-content" id="tab5">
                    <div class="card">
                        <h2><i class="fas fa-lightbulb"></i> 综合命理建议</h2>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 25px 0;">
                            <div style="flex: 1; min-width: 300px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 25px; border-radius: 12px;">
                                <strong style="font-size: 18px;"><i class="fas fa-user-check"></i> 性格特征</strong>
                                <div style="margin-top: 15px; line-height: 1.7;" id="character-analysis"></div>
                            </div>
                            <div style="flex: 1; min-width: 300px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 25px; border-radius: 12px;">
                                <strong style="font-size: 18px;"><i class="fas fa-briefcase"></i> 事业发展</strong>
                                <div style="margin-top: 15px; line-height: 1.7;" id="career-analysis"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 25px 0;">
                            <div style="flex: 1; min-width: 300px; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 25px; border-radius: 12px;">
                                <strong style="font-size: 18px;"><i class="fas fa-money-bill-wave"></i> 财运分析</strong>
                                <div style="margin-top: 15px; line-height: 1.7;" id="wealth-analysis"></div>
                            </div>
                            <div style="flex: 1; min-width: 300px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 25px; border-radius: 12px;">
                                <strong style="font-size: 18px;"><i class="fas fa-heart"></i> 感情婚姻</strong>
                                <div style="margin-top: 15px; line-height: 1.7;" id="relationship-analysis"></div>
                            </div>
                        </div>
                        
                        <h3><i class="fas fa-hands-helping"></i> 五行调节建议</h3>
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 25px 0;">
                            <div id="element-advice"></div>
                        </div>
                        
                        <h3><i class="fas fa-exclamation-triangle"></i> 注意事项</h3>
                        <div style="background: rgba(231, 76, 60, 0.1); padding: 25px; border-radius: 12px; margin: 25px 0; border-left: 5px solid #e74c3c;">
                            <div id="cautions"></div>
                        </div>
                        
                        <h3><i class="fas fa-trophy"></i> 命理分析总评分</h3>
                        <div class="score-display">
                            <div class="score-item" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                                <div class="name"><i class="fas fa-star"></i> 综合评分</div>
                                <div class="value" id="overall-score">0</div>
                                <div class="grade" id="overall-grade"></div>
                            </div>
                            <div class="score-item" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                                <div class="name"><i class="fas fa-chess-board"></i> 格局评分</div>
                                <div class="value" id="pattern-score">0</div>
                                <div class="grade" id="pattern-grade"></div>
                            </div>
                            <div class="score-item" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
                                <div class="name"><i class="fas fa-balance-scale"></i> 平衡指数</div>
                                <div class="value" id="balance-index">0%</div>
                                <div class="grade" id="balance-grade"></div>
                            </div>
                            <div class="score-item" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white;">
                                <div class="name"><i class="fas fa-magic"></i> 神煞评分</div>
                                <div class="value" id="shen-sha-score">0</div>
                                <div class="grade" id="shen-sha-grade"></div>
                            </div>
                        </div>
                        
                        <h3><i class="fas fa-list-ul"></i> 详细命理分析报告</h3>
                        <div class="analysis-item">
                            <h4><i class="fas fa-user"></i> 个人命格分析</h4>
                            <div id="personal-analysis"></div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4><i class="fas fa-chart-line"></i> 运势发展分析</h4>
                            <div id="fortune-analysis"></div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4><i class="fas fa-shield-alt"></i> 防范风险建议</h4>
                            <div id="risk-prevention"></div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4><i class="fas fa-star"></i> 贵人运分析</h4>
                            <div id="nobleman-analysis"></div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4><i class="fas fa-hourglass-start"></i> 大运流年综合评分</h4>
                            <div id="da-yun-score"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 紫微扩展分析选项卡 -->
                <div class="tab-content" id="tab6">
                    <div class="card">
                        <h2><i class="fas fa-star"></i> 紫微扩展分析（星曜组合、宫位体系、优化吉凶）</h2>
                        
                        <!-- 优化吉凶评分 -->
                        <h3><i class="fas fa-chart-pie"></i> 多维度加权评分系统</h3>
                        <div style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.1) 0%, rgba(142, 68, 173, 0.05) 100%); padding: 25px; border-radius: 15px; margin: 25px 0; border: 2px solid #9b59b6;">
                            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 1; min-width: 200px; text-align: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                    <div style="font-size: 36px; font-weight: bold; color: #9b59b6;" id="ziwei-total-score">0</div>
                                    <div style="color: #7f8c8d; margin-top: 5px;">总评分 (满分100)</div>
                                    <div style="margin-top: 10px; font-size: 18px; color: #2ecc71; font-weight: 600;" id="ziwei-fortune-level">-</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="ziwei-element-score">0</div>
                                    <div style="color: #7f8c8d; font-size: 12px;">五行平衡 (30分)</div>
                                </div>
                                <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2ecc71;" id="ziwei-pattern-score">0</div>
                                    <div style="color: #7f8c8d; font-size: 12px;">格局分析 (25分)</div>
                                </div>
                                <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #e74c3c;" id="ziwei-shensha-score">0</div>
                                    <div style="color: #7f8c8d; font-size: 12px;">神煞吉凶 (20分)</div>
                                </div>
                                <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="ziwei-star-score">0</div>
                                    <div style="color: #7f8c8d; font-size: 12px;">星曜组合 (15分)</div>
                                </div>
                                <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #1abc9c;" id="ziwei-palace-score">0</div>
                                    <div style="color: #7f8c8d; font-size: 12px;">宫位四化 (10分)</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 10px; border-left: 4px solid #9b59b6;">
                                <strong style="color: #9b59b6;"><i class="fas fa-star"></i> 核心结论：</strong>
                                <div style="margin-top: 10px; color: #34495e; line-height: 1.8;" id="ziwei-core-conclusion"></div>
                            </div>
                        </div>
                        
                        <!-- 星曜组合分析 -->
                        <h3><i class="fas fa-star-of-david"></i> 星曜组合规则分析</h3>
                        <div id="star-combination-container" style="margin: 25px 0;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <!-- 三方四正分析 -->
                                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-project-diagram"></i> 三方四正分析</h4>
                                    <div id="sanfang-sizheng-content" style="color: #34495e; line-height: 1.8;"></div>
                                </div>
                                <!-- 星曜克制关系 -->
                                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <h4 style="color: #e74c3c; margin-bottom: 15px;"><i class="fas fa-arrows-alt"></i> 星曜克制关系</h4>
                                    <div id="star-restraint-content" style="color: #34495e; line-height: 1.8;"></div>
                                </div>
                                <!-- 关键会照组合 -->
                                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <h4 style="color: #f39c12; margin-bottom: 15px;"><i class="fas fa-star"></i> 关键会照组合</h4>
                                    <div id="key-combination-content" style="color: #34495e; line-height: 1.8;"></div>
                                </div>
                                <!-- 六合分析（新增） -->
                                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <h4 style="color: #27ae60; margin-bottom: 15px;"><i class="fas fa-balance-scale"></i> 六合分析</h4>
                                    <div id="six-hui-content" style="color: #34495e; line-height: 1.8;"></div>
                                </div>
                                <!-- 贵人会照分析（新增） -->
                                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <h4 style="color: #8e44ad; margin-bottom: 15px;"><i class="fas fa-user-check"></i> 贵人会照分析</h4>
                                    <div id="noble-content" style="color: #34495e; line-height: 1.8;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 宫位分析体系 -->
                        <h3><i class="fas fa-compass"></i> 十二宫位分析体系</h3>
                        <div style="margin: 25px 0;">
                            <!-- 命宫信息 -->
                            <div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                                <h4 style="color: #3498db; margin-bottom: 15px;"><i class="fas fa-home"></i> 命宫信息</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 20px;" id="life-palace-info"></div>
                            </div>
                            <!-- 宫位旺衰分析（新增） -->
                            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 16px;">
                                <h4 style="color: #2c3e50; margin-bottom: 12px;"><i class="fas fa-chart-line"></i> 宫位旺衰分析</h4>
                                <div id="palace-fortune-container" style="color: #34495e; line-height: 1.8;"></div>
                            </div>
                            </div>
                            
                            <!-- 各宫位四化表格 -->
                            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <h4 style="color: #2c3e50; margin-bottom: 20px;"><i class="fas fa-table"></i> 各宫位四化与五行占比</h4>
                                <div style="overflow-x: auto;">
                                    <table class="bazi-table" style="width: 100%;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 12px; text-align: center;">宫位</th>
                                                <th style="padding: 12px; text-align: center;">地支</th>
                                                <th style="padding: 12px; text-align: center;">禄</th>
                                                <th style="padding: 12px; text-align: center;">权</th>
                                                <th style="padding: 12px; text-align: center;">科</th>
                                                <th style="padding: 12px; text-align: center;">忌</th>
                                                <th style="padding: 12px; text-align: center;">五行占比</th>
                                            </tr>
                                        </thead>
                                        <tbody id="palace-sihua-tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- 宫位解读 -->
                            <div style="margin-top: 20px;" id="palace-interpretation"></div>
                        </div>
                        
                        <!-- 详细分析建议 -->
                        <h3><i class="fas fa-clipboard-list"></i> 紫微扩展详细解读</h3>
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 25px 0;">
                            <div id="ziwei-detailed-analysis" style="color: #34495e; line-height: 2;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 直接引入所有脚本文件 -->
    <script src="bazi-knowledge.js"></script>
    <script src="ziwei-knowledge.js"></script>
    <script src="bazi_completeV2.js"></script>
    <script src="ziwei.js"></script>
    <script>
        // 调试信息
        window.addEventListener('load', function() {
            console.log('页面加载完成');
            console.log('BaziCalculator:', typeof BaziCalculator);
            console.log('BaziExtendedAnalyzer:', typeof BaziExtendedAnalyzer);
            if (typeof BaziCalculator === 'undefined') {
                console.error('BaziCalculator未定义');
            } else {
                console.log('BaziCalculator已成功加载');
            }
        });
    </script>
    
    <script>
        // 移除原有的模块检查逻辑，由新的脚本加载器处理
        
        // 全局变量
        let currentBazi = null;
        let currentFormatted = null;
        
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('八字命盘系统初始化...');
            
            // 初始化城市选择与经度输入联动
            initCityLongitude();
            
            // 初始化选项卡
            initTabs();
            
            // 绑定计算按钮事件
            bindCalculateButton();
            
            // 设置默认示例（可选）
            // setTimeout(() => {
            //     document.getElementById('calculate-btn').click();
            // }, 500);
        });
        
        // 初始化城市与经度输入联动
        function initCityLongitude() {
            const citySelect = document.getElementById('city-select');
            const longitudeInput = document.getElementById('longitude-input');
            
            if (citySelect && longitudeInput) {
                citySelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        longitudeInput.readOnly = false;
                        longitudeInput.focus();
                        longitudeInput.value = '';
                    } else if (this.value) {
                        const [lng, lat] = this.value.split(',');
                        longitudeInput.readOnly = true;
                        longitudeInput.value = lng;
                    } else {
                        longitudeInput.readOnly = true;
                        longitudeInput.value = '';
                    }
                });
                
                // 设置默认值
                if (citySelect.value) {
                    const [lng, lat] = citySelect.value.split(',');
                    longitudeInput.value = lng;
                }
            }
        }
        
        // 初始化选项卡
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // 移除所有active类
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // 添加当前active类
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // 绑定计算按钮事件
        function bindCalculateButton() {
            const calculateBtn = document.getElementById('calculate-btn');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const resultDiv = document.getElementById('result');
            
            if (calculateBtn) {
                calculateBtn.addEventListener('click', function() {
                    console.log('开始计算八字命盘...');
                    
                    try {
                        // 验证输入
                        if (!validateInputs()) {
                            alert('请填写完整的出生信息！');
                            return;
                        }
                        
                        // 显示加载状态
                        loadingDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                        resultDiv.style.display = 'none';
                        
                        // 获取用户输入
                        const birthDateStr = document.getElementById('birth-date').value;
                        const birthHour = parseInt(document.getElementById('birth-hour').value);
                        const longitude = parseFloat(document.getElementById('longitude-input').value);
                        const isMale = document.getElementById('gender-select').value === 'male';
                        
                        // 构造日期对象
                        const [year, month, day] = birthDateStr.split('-').map(Number);
                        const birthDate = new Date(year, month - 1, day, birthHour, 0);
                        
                        // 延迟执行以显示加载效果
                        setTimeout(() => {
                                try {
                                    // 确保BaziCalculator已加载
                                    if (typeof BaziCalculator === 'undefined') {
                                        throw new Error('BaziCalculator未定义，请检查脚本加载顺序');
                                    }
                                    
                                    // 验证日期有效性
                                    if (isNaN(birthDate.getTime())) {
                                        throw new Error('无效的出生日期');
                                    }
                                    
                                    // 调用核心算法库
                                    console.log('调用BaziCalculator.generate...');
                                    currentBazi = BaziCalculator.generate(birthDate, longitude, isMale);
                                    currentFormatted = BaziCalculator.format(currentBazi);
                                    
                                    // 渲染所有结果
                                    renderAllResults(currentFormatted, currentBazi);
                                    
                                    // 只执行一次紫微扩展分析，避免重复计算导致不一致
                                    if (typeof BaziExtendedAnalyzer !== 'undefined') {
                                      try {
                                        const ext = BaziExtendedAnalyzer.analyze(currentBazi);
                                        console.log('统一的BaziExtendedAnalyzer结果:', ext);
                                        
                                        // 同时更新两个展示区域
                                        if (typeof renderZiweiExtendedUI === 'function') {
                                          renderZiweiExtendedUI(ext);
                                        }
                                        
                                        // 更新综合分析区域
                                        renderZiweiExtendedAnalysis(ext, currentBazi);
                                      } catch (e) {
                                        console.error('紫微扩展分析失败', e);
                                      }
                                    }
                                    
                                    // 显示结果，隐藏加载
                                    loadingDiv.style.display = 'none';
                                    resultDiv.style.display = 'block';
                                    
                                    // 滚动到结果区域
                                    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    
                                    console.log('八字计算完成！');
                                } catch (err) {
                                    console.error('计算错误：', err);
                                    loadingDiv.style.display = 'none';
                                    errorDiv.style.display = 'block';
                                    errorDiv.innerHTML = `<p><i class="fas fa-exclamation-triangle"></i> 计算出错：${err.message}</p>`;
                                }
                        }, 800);
                        
                    } catch (err) {
                        console.error('输入错误：', err);
                        loadingDiv.style.display = 'none';
                        errorDiv.style.display = 'block';
                    }
                });
            }
        }
        
        // 验证输入
        function validateInputs() {
            const birthDate = document.getElementById('birth-date').value;
            const longitude = document.getElementById('longitude-input').value;
            
            if (!birthDate) return false;
            if (!longitude || isNaN(parseFloat(longitude))) return false;
            
            return true;
        }
        
        // 渲染所有结果
        function renderAllResults(formatted, rawBazi) {
            try {
                // 1. 基础八字信息
                renderBasicInfo(formatted, rawBazi);
                
                // 2. 格局分析
                renderPatternAnalysis(formatted);
                
                // 3. 神煞系统
                renderShenSha(formatted);
                
                // 4. 大运流年
                renderDayunAndLiunian(formatted, rawBazi);
                
                // 5. 综合建议
                renderComprehensiveAdvice(formatted, rawBazi);
                
                // 注意：紫微扩展分析已在上面统一处理，避免重复计算
                
            } catch (error) {
                console.error('渲染结果时出错:', error);
            }
        }
        
        // 渲染基础八字信息
        function renderBasicInfo(formatted, rawBazi) {
            try {
                // 四柱干支
                const pillars = formatted.basicInfo.pillars;
                document.getElementById('pillar-year').textContent = pillars.year.split(' ')[0];
                document.getElementById('pillar-month').textContent = pillars.month.split(' ')[0];
                document.getElementById('pillar-day').textContent = pillars.day.split(' ')[0];
                document.getElementById('pillar-hour').textContent = pillars.hour.split(' ')[0];
                
                // 藏干
                document.getElementById('canggan-year').textContent = rawBazi.hiddenStems?.year || '';
                document.getElementById('canggan-month').textContent = rawBazi.hiddenStems?.month || '';
                document.getElementById('canggan-day').textContent = rawBazi.hiddenStems?.day || '';
                document.getElementById('canggan-hour').textContent = rawBazi.hiddenStems?.hour || '';
                
                // 纳音
                document.getElementById('nayin-year').textContent = formatted.basicInfo.pillars.year.split('(')[1]?.replace(')', '') || '';
                document.getElementById('nayin-month').textContent = formatted.basicInfo.pillars.month.split('(')[1]?.replace(')', '') || '';
                document.getElementById('nayin-day').textContent = formatted.basicInfo.pillars.day.split('(')[1]?.replace(')', '') || '';
                document.getElementById('nayin-hour').textContent = formatted.basicInfo.pillars.hour.split('(')[1]?.replace(')', '') || '';
                
                // 十神
                document.getElementById('shishen-year').textContent = formatted.tenGods?.year || '';
                document.getElementById('shishen-month').textContent = formatted.tenGods?.month || '';
                document.getElementById('shishen-day').textContent = formatted.tenGods?.day || '';
                document.getElementById('shishen-hour').textContent = formatted.tenGods?.hour || '';
                
                // 地势
                document.getElementById('dishi-year').textContent = rawBazi.diShi?.year || '';
                document.getElementById('dishi-month').textContent = rawBazi.diShi?.month || '';
                document.getElementById('dishi-day').textContent = rawBazi.diShi?.day || '';
                document.getElementById('dishi-hour').textContent = rawBazi.diShi?.hour || '';
                
                // 空亡
                document.getElementById('kongwang-year').textContent = rawBazi.kongWang?.year || '';
                document.getElementById('kongwang-month').textContent = rawBazi.kongWang?.month || '';
                document.getElementById('kongwang-day').textContent = rawBazi.kongWang?.day || '';
                document.getElementById('kongwang-hour').textContent = rawBazi.kongWang?.hour || '';
                
                // 神煞（按柱分类）
                if (rawBazi.shenSha) {
                    const shenShaByPillar = { year: [], month: [], day: [], hour: [] };
                    
                    // 获取四柱的地支
                    const yearBranch = pillars.year ? pillars.year.charAt(1) : '';
                    const monthBranch = pillars.month ? pillars.month.charAt(1) : '';
                    const dayBranch = pillars.day ? pillars.day.charAt(1) : '';
                    const hourBranch = pillars.hour ? pillars.hour.charAt(1) : '';
                    
                    // 创建地支到柱的映射
                    const branchToPillar = {};
                    if (yearBranch) branchToPillar[yearBranch] = 'year';
                    if (monthBranch) branchToPillar[monthBranch] = 'month';
                    if (dayBranch) branchToPillar[dayBranch] = 'day';
                    if (hourBranch) branchToPillar[hourBranch] = 'hour';
                    
                    for (const [name, config] of Object.entries(rawBazi.shenSha)) {
                        if (config.positions && config.positions.length > 0) {
                            // 添加类型标识
                            let typeTag = '';
                            if (config.type === '吉') {
                                typeTag = '[吉]';
                            } else if (config.type === '凶') {
                                typeTag = '[凶]';
                            } else if (config.type === '半吉半凶') {
                                typeTag = '[中]';
                            }
                            
                            // 检查神煞位置是否在四柱中
                            let matched = false;
                            config.positions.forEach(pos => {
                                if (branchToPillar[pos]) {
                                    shenShaByPillar[branchToPillar[pos]].push(`${typeTag}${name}`);
                                    matched = true;
                                }
                            });
                            
                            // 如果没有匹配到任何柱，但神煞存在，添加到日柱（作为本命神煞）
                            if (!matched) {
                                shenShaByPillar.day.push(`${typeTag}${name}(本命)`);
                            }
                        }
                    }
                    
                    document.getElementById('shensha-year').textContent = shenShaByPillar.year.join('\n') || '无';
                    document.getElementById('shensha-month').textContent = shenShaByPillar.month.join('\n') || '无';
                    document.getElementById('shensha-day').textContent = shenShaByPillar.day.join('\n') || '无';
                    document.getElementById('shensha-hour').textContent = shenShaByPillar.hour.join('\n') || '无';
                }
                
                // 五行分布
                const elementBalance = formatted.elementBalance;
                if (elementBalance.distribution) {
                    document.getElementById('element-wood').textContent = elementBalance.distribution.木 || '0%';
                    document.getElementById('element-fire').textContent = elementBalance.distribution.火 || '0%';
                    document.getElementById('element-earth').textContent = elementBalance.distribution.土 || '0%';
                    document.getElementById('element-metal').textContent = elementBalance.distribution.金 || '0%';
                    document.getElementById('element-water').textContent = elementBalance.distribution.水 || '0%';
                    
                    if (elementBalance.scores) {
                        document.getElementById('score-wood').textContent = `得分: ${elementBalance.scores.木 || 0}`;
                        document.getElementById('score-fire').textContent = `得分: ${elementBalance.scores.火 || 0}`;
                        document.getElementById('score-earth').textContent = `得分: ${elementBalance.scores.土 || 0}`;
                        document.getElementById('score-metal').textContent = `得分: ${elementBalance.scores.金 || 0}`;
                        document.getElementById('score-water').textContent = `得分: ${elementBalance.scores.水 || 0}`;
                    }
                }
                
                // 日主和综合评分
                document.getElementById('day-master').textContent = 
                    `${formatted.basicInfo.dayMaster.gan}(${formatted.basicInfo.dayMaster.element}) ${formatted.basicInfo.dayMaster.yinYang}`;
                
                document.getElementById('total-score').textContent = formatted.summary.totalScore;
                
                // 最强最弱五行
                if (elementBalance.strongest && elementBalance.weakest) {
                    document.getElementById('element-strongest').textContent = 
                        `${elementBalance.strongest.element} (${elementBalance.strongest.value})`;
                    document.getElementById('element-weakest').textContent = 
                        `${elementBalance.weakest.element} (${elementBalance.weakest.value})`;
                }
                
            } catch (error) {
                console.error('渲染基础信息时出错:', error);
            }
        }
        
        // 渲染格局分析
        function renderPatternAnalysis(formatted) {
            try {
                const patternAnalysis = formatted.patternAnalysis;
                
                // 格局等级
                document.getElementById('pattern-level').textContent = 
                    `${patternAnalysis.level?.level || '普通'} (${patternAnalysis.level?.score || 50}分)`;
                
                // 主格局
                if (patternAnalysis.mainPattern) {
                    document.getElementById('main-pattern').textContent = 
                        `${patternAnalysis.mainPattern.name} (${patternAnalysis.mainPattern.score}分)`;
                }
                
                // 格局数量
                const patternCount = patternAnalysis.allPatterns?.length || 0;
                document.getElementById('pattern-count').textContent = `${patternCount}个`;
                
                // 所有格局列表
                const container = document.getElementById('pattern-container');
                container.innerHTML = '';
                
                if (patternAnalysis.allPatterns && patternAnalysis.allPatterns.length > 0) {
                    patternAnalysis.allPatterns.forEach(pattern => {
                        const typeClass = pattern.type === '特殊格局' ? 'type-特殊' : 
                                        pattern.type === '综合格局' ? 'type-综合' : 'type-zhengge';
                        
                        const html = `
                            <div class="pattern-card">
                                <div class="title">
                                    ${pattern.name}
                                    <span class="score">${pattern.score}分</span>
                                </div>
                                <div class="type ${typeClass}">${pattern.type} - ${pattern.subtype || ''}</div>
                                <div class="desc">${pattern.desc}</div>
                            </div>
                        `;
                        container.innerHTML += html;
                    });
                } else {
                    container.innerHTML = '<p style="text-align:center;color:#7f8c8d;">未检测到明显格局</p>';
                }
                
                // 喜用神与忌神
                const usefulGodsContainer = document.getElementById('useful-gods');
                const avoidGodsContainer = document.getElementById('avoid-gods');
                
                if (patternAnalysis.usefulGods && patternAnalysis.usefulGods.length > 0) {
                    usefulGodsContainer.innerHTML = patternAnalysis.usefulGods.map(god => 
                        `<div style="margin-bottom: 8px;"><strong>${god.type}:</strong> ${god.element} - ${god.desc}</div>`
                    ).join('');
                } else {
                    usefulGodsContainer.innerHTML = '<p style="color:#7f8c8d;">无特别喜用神</p>';
                }
                
                if (patternAnalysis.avoidGods && patternAnalysis.avoidGods.length > 0) {
                    avoidGodsContainer.innerHTML = patternAnalysis.avoidGods.map(god => 
                        `<div style="margin-bottom: 8px;"><strong>${god.type}:</strong> ${god.element} - ${god.desc}</div>`
                    ).join('');
                } else {
                    avoidGodsContainer.innerHTML = '<p style="color:#7f8c8d;">无特别忌神</p>';
                }
                
            } catch (error) {
                console.error('渲染格局分析时出错:', error);
            }
        }
        
        // 渲染神煞系统
        function renderShenSha(formatted) {
            try {
                const shenShaList = formatted.shenSha || [];
                
                // 统计神煞数量
                let jiCount = 0, xiongCount = 0, banCount = 0;
                
                shenShaList.forEach(item => {
                    if (item.type === '吉') jiCount++;
                    else if (item.type === '凶') xiongCount++;
                    else if (item.type === '半吉半凶') banCount++;
                });
                
                // 更新计数
                document.getElementById('shensha-ji-count').textContent = jiCount;
                document.getElementById('shensha-xiong-count').textContent = xiongCount;
                document.getElementById('shensha-ban-count').textContent = banCount;
                document.getElementById('shensha-total-count').textContent = shenShaList.length;
                
                // 渲染神煞卡片
                const container = document.getElementById('shensha-container');
                container.innerHTML = '';
                
                if (shenShaList.length > 0) {
                    shenShaList.forEach(item => {
                        let typeClass = 'shensha-ban';
                        let typeText = '中性';
                        let typeColor = '#f1c40f';
                        
                        if (item.type === '吉') {
                            typeClass = 'shensha-ji';
                            typeText = '吉';
                            typeColor = '#2ecc71';
                        } else if (item.type === '凶') {
                            typeClass = 'shensha-xiong';
                            typeText = '凶';
                            typeColor = '#e74c3c';
                        }
                        
                        const html = `
                            <div class="shensha-card ${typeClass}" style="background: white; border: 1px solid #e2e8f0;">
                                <div class="name">
                                    ${item.name}
                                    <span class="type" style="background: ${typeColor}">${typeText}</span>
                                </div>
                                <div class="desc">${item.desc}</div>
                            </div>
                        `;
                        container.innerHTML += html;
                    });
                } else {
                    container.innerHTML = '<p style="text-align:center;color:#7f8c8d;grid-column:1/-1;">未检测到神煞</p>';
                }
                
            } catch (error) {
                console.error('渲染神煞系统时出错:', error);
            }
        }
        
        // 渲染大运流年
        function renderDayunAndLiunian(formatted, rawBazi) {
            try {
                const daYun = formatted.daYun;
                
                // 大运基本信息
                document.getElementById('dayun-start').textContent = daYun.startAge || '未知';
                document.getElementById('dayun-direction').textContent = daYun.direction || '未知';
                
                // 计算起运年份
                if (daYun.startAge && rawBazi.solarTermInfo) {
                    const birthYear = new Date(document.getElementById('birth-date').value).getFullYear();
                    const startYear = birthYear + parseInt(daYun.startAge);
                    document.getElementById('dayun-year').textContent = startYear + '年';
                } else {
                    document.getElementById('dayun-year').textContent = '未知';
                }
                
                // 大运详细解析
                const dayunContainer = document.getElementById('dayun-container');
                dayunContainer.innerHTML = '';
                
                if (daYun.stages && daYun.stages.length > 0) {
                    daYun.stages.forEach((stage, index) => {
                        const advice = getDaYunAdvice(stage);
                        
                        const html = `
                            <div class="yun-stage">
                                <div class="header">
                                    <div class="title">第${index+1}步大运：${stage.ganZhi}</div>
                                    <div class="age">${stage.ageRange}</div>
                                </div>
                                <div class="details">
                                    <div class="detail-item">
                                        <div class="detail-label">十神</div>
                                        <div class="detail-value">${stage.tenGod}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">五行</div>
                                        <div class="detail-value">${stage.element}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">起止年龄</div>
                                        <div class="detail-value">${stage.ageRange || (stage.startAge + ' - ' + stage.endAge + '岁') || '未知'}</div>
                                    </div>
                                </div>
                                <div style="color: #34495e; line-height: 1.7; margin-top: 15px;">
                                    <strong>运势解析：</strong>${advice}
                                </div>
                            </div>
                        `;
                        dayunContainer.innerHTML += html;
                    });
                } else {
                    dayunContainer.innerHTML = '<p style="text-align:center;color:#7f8c8d;">暂无大运信息</p>';
                }
                
                // 流年解析
                const liunianContainer = document.getElementById('liunian-container');
                liunianContainer.innerHTML = '';
                
                if (formatted.liuNian && formatted.liuNian.length > 0) {
                    // 只显示未来3年
                    formatted.liuNian.slice(0, 3).forEach(nian => {
                        const html = `
                            <div class="yun-stage">
                                <div class="header">
                                    <div class="title">${nian.year}年：${nian.ganZhi}</div>
                                    <div class="age">流年</div>
                                </div>
                                <div class="details">
                                    <div class="detail-item">
                                        <div class="detail-label">十神</div>
                                        <div class="detail-value">${nian.tenGod}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">冲合</div>
                                        <div class="detail-value">${nian.chongHe}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">神煞</div>
                                        <div class="detail-value">${nian.shenSha || '无'}</div>
                                    </div>
                                </div>
                                <div style="color: #34495e; line-height: 1.7; margin-top: 15px;">
                                    <strong>流年建议：</strong>${getLiuNianAdvice(nian)}
                                </div>
                            </div>
                        `;
                        liunianContainer.innerHTML += html;
                    });
                } else {
                    liunianContainer.innerHTML = '<p style="text-align:center;color:#7f8c8d;">暂无流年信息</p>';
                }
                
                // 流年综合分析表格
                const liunianAnalysisTbody = document.getElementById('liunian-analysis-tbody');
                if (liunianAnalysisTbody && formatted.liuNian && formatted.liuNian.length > 0) {
                    liunianAnalysisTbody.innerHTML = '';
                    formatted.liuNian.slice(0, 3).forEach(nian => {
                        const rowHtml = `
                            <tr>
                                <td class="year-cell">${nian.year}</td>
                                <td>${nian.ganZhi}</td>
                                <td>${nian.tenGod}</td>
                                <td>${nian.chongHe || '无'}</td>
                                <td>${nian.shenSha || '无'}</td>
                                <td class="score-cell">${nian.score || 60}分</td>
                                <td class="advice-cell">${getLiuNianAdvice(nian)}</td>
                            </tr>
                        `;
                        liunianAnalysisTbody.innerHTML += rowHtml;
                    });
                } else if (liunianAnalysisTbody) {
                    liunianAnalysisTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#7f8c8d;">暂无流年分析数据</td></tr>';
                }
                
            } catch (error) {
                console.error('渲染大运流年时出错:', error);
            }
        }
        
        // 渲染综合建议
        function renderComprehensiveAdvice(formatted, rawBazi) {
            try {
                // 性格特征
                const dayMaster = formatted.basicInfo.dayMaster;
                const element = dayMaster.element;
                const score = parseInt(formatted.summary.totalScore.split('/')[0]);
                
                // 常用数据映射（在整个函数中共享）
                const characterMap = {
                    '木': '性格温和，思维敏捷，有上进心，重视精神层面的追求，但有时易犹豫不决',
                    '火': '性格热情开朗，积极主动，有创造力，但有时易冲动急躁，缺乏耐心',
                    '土': '性格稳重踏实，诚实守信，有责任感，但有时易固执保守，缺乏变通',
                    '金': '性格刚毅果断，讲义气，有魄力，但有时易刚愎自用，缺乏人情味',
                    '水': '性格聪明机智，思维活跃，适应能力强，但有时易多变不定，缺乏定力'
                };
                
                const careerMap = {
                    '木': '适合从事文化、教育、艺术、林业、医药等行业，宜往东、东南方向发展',
                    '火': '适合从事能源、电力、餐饮、娱乐、公关等行业，宜往南方向发展',
                    '土': '适合从事房地产、建筑、农业、金融等行业，宜往本地或西南、东北方向发展',
                    '金': '适合从事金融、金属、机械、五金等行业，宜往西、西北方向发展',
                    '水': '适合从事水利、物流、旅游、贸易等行业，宜往北方向发展'
                };
                
                const wealthMap = {
                    '木': '财运平稳，正财为主，不宜投机，宜通过自身努力积累财富',
                    '火': '财运起伏较大，偏财机会多，但也易破财，需理性理财',
                    '土': '财运稳定，守财能力强，宜稳健投资，不宜冒进',
                    '金': '财运佳，赚钱能力强，但也易挥霍，需注意储蓄',
                    '水': '财运灵活，易得意外之财，但也易财来财去，需做好财务规划'
                };
                
                const relationshipMap = {
                    '木': '感情细腻，重视精神共鸣，宜找性格互补的伴侣，注意沟通方式',
                    '火': '感情热烈，追求浪漫，宜找性格稳重的伴侣，避免情绪化冲突',
                    '土': '感情务实，重视家庭，宜找性格开朗的伴侣，增加生活情趣',
                    '金': '感情直接，重视承诺，宜找性格温柔的伴侣，避免硬碰硬',
                    '水': '感情多变，追求新鲜感，宜找性格坚定的伴侣，增加稳定性'
                };
                
                const elementColors = {
                    '木': '绿色、青色',
                    '火': '红色、紫色',
                    '土': '黄色、棕色',
                    '金': '白色、金色',
                    '水': '黑色、蓝色'
                };
                
                const elementDirections = {
                    '木': '东方、东南方',
                    '火': '南方',
                    '土': '中央、西南方、东北方',
                    '金': '西方、西北方',
                    '水': '北方'
                };
                
                // 获取喜用神和忌神
                const usefulGods = formatted.patternAnalysis.usefulGods || [];
                const avoidGods = formatted.patternAnalysis.avoidGods || [];
                
                // 填充内容
                document.getElementById('character-analysis').textContent = 
                    characterMap[element] || '性格特征分析暂时不可用';
                
                document.getElementById('career-analysis').textContent = 
                    careerMap[element] || '事业发展分析暂时不可用';
                
                document.getElementById('wealth-analysis').textContent = 
                    wealthMap[element] || '财运分析暂时不可用';
                
                document.getElementById('relationship-analysis').textContent = 
                    relationshipMap[element] || '感情婚姻分析暂时不可用';
                
                // 五行调节建议
                const elementAdvice = document.getElementById('element-advice');
                
                if (usefulGods.length > 0) {
                    const elements = usefulGods.map(god => god.element).filter((v, i, a) => a.indexOf(v) === i);
                    
                    let adviceHtml = `
                        <p>根据命局分析，您的喜用五行是：<strong>${elements.join('、')}</strong>。建议：</p>
                        <ul style="margin-top: 15px; padding-left: 20px;">
                    `;
                    
                    elements.forEach(el => {
                        adviceHtml += `
                            <li style="margin-bottom: 10px;">
                                <strong>${el}元素：</strong>
                                宜多使用${elementColors[el]}系物品，往${elementDirections[el]}方向发展，
                                从事与${el}相关的行业更易获得成功。
                            </li>
                        `;
                    });
                    
                    adviceHtml += '</ul>';
                    elementAdvice.innerHTML = adviceHtml;
                } else {
                    elementAdvice.innerHTML = '<p>暂无五行调节建议</p>';
                }
                
                // 注意事项
                const cautions = document.getElementById('cautions');
                const xiongShenSha = formatted.shenSha?.filter(s => s.type === '凶') || [];
                
                let cautionHtml = '<p>需要特别注意的事项：</p><ul style="margin-top: 15px; padding-left: 20px;">';
                
                if (avoidGods.length > 0) {
                    const avoidElements = avoidGods.map(god => god.element).filter((v, i, a) => a.indexOf(v) === i);
                    cautionHtml += `<li style="margin-bottom: 10px;">忌神五行：<strong>${avoidElements.join('、')}</strong>，应尽量避免接触相关属性的事物。</li>`;
                }
                
                if (xiongShenSha.length > 0) {
                    const shenShaNames = xiongShenSha.map(s => s.name);
                    cautionHtml += `<li style="margin-bottom: 10px;">凶煞：<strong>${shenShaNames.join('、')}</strong>，相关年份需格外谨慎，避免冲动决策。</li>`;
                }
                
                if (score < 60) {
                    cautionHtml += `<li style="margin-bottom: 10px;">命局综合评分${score}分，属于中等偏下，需更加努力奋斗，稳扎稳打。</li>`;
                }
                
                if (formatted.tenGods?.day === '伤官' || formatted.tenGods?.day === '七杀') {
                    cautionHtml += `<li style="margin-bottom: 10px;">日坐伤官/七杀，性格较为刚烈，需注意人际关系，避免口舌是非。</li>`;
                }
                
                cautionHtml += '</ul>';
                cautions.innerHTML = cautionHtml;
                
                // 详细命理分析报告
                // 1. 个人命格分析
                const personalAnalysis = document.getElementById('personal-analysis');
                const mainPattern = formatted.patternAnalysis.mainPattern;
                const dayMasterDesc = characterMap[element] || '';
                personalAnalysis.innerHTML = `
                    <p><strong>日主特性：</strong>${dayMaster.gan}日主属${element}，${dayMasterDesc}</p>
                    <p style="margin-top: 10px;"><strong>命格特点：</strong>${mainPattern ? mainPattern.name + ' - ' + mainPattern.desc : '命格平和，无明显偏格'}</p>
                    <p style="margin-top: 10px;"><strong>性格优势：</strong>根据五行分析，您${score >= 70 ? '命格较好，具备较强的适应能力和发展潜力' : score >= 50 ? '命格中等，通过努力可以获得不错的成就' : '命格偏弱，需要更多努力和贵人相助'}</p>
                `;
                
                // 2. 运势发展分析
                const fortuneAnalysis = document.getElementById('fortune-analysis');
                const currentDaYun = formatted.daYun?.stages?.[0];
                fortuneAnalysis.innerHTML = `
                    <p><strong>当前运势：</strong>${currentDaYun ? currentDaYun.tenGod + '大运，' + getDaYunAdvice(currentDaYun) : '运势平稳，宜稳扎稳打'}</p>
                    <p style="margin-top: 10px;"><strong>发展方向：</strong>${careerMap[element]}</p>
                    <p style="margin-top: 10px;"><strong>时机把握：</strong>建议${usefulGods.length > 0 ? '多借助' + usefulGods.map(g => g.element).join('、') + '的力量，在相应年份积极进取' : '保持稳健，等待时机'}</p>
                `;
                
                // 3. 防范风险建议
                const riskPrevention = document.getElementById('risk-prevention');
                const jiShenSha = formatted.shenSha?.filter(s => s.type === '凶') || [];
                riskPrevention.innerHTML = `
                    <p><strong>主要风险：</strong>${jiShenSha.length > 0 ? '注意' + jiShenSha.slice(0, 3).map(s => s.name).join('、') + '等凶煞影响' : '整体风险可控，但仍需谨慎'}</p>
                    <p style="margin-top: 10px;"><strong>防范措施：</strong>${avoidGods.length > 0 ? '避免接触' + avoidGods.map(g => g.element).join('、') + '属性过强的事物和环境' : '保持低调，避免冲动决策'}</p>
                    <p style="margin-top: 10px;"><strong>特别注意：</strong>${score < 60 ? '命局偏弱，重大决策前建议咨询专业人士' : '运势总体良好，但仍需防微杜渐'}</p>
                `;
                
                // 4. 贵人运分析
                const noblemanAnalysis = document.getElementById('nobleman-analysis');
                const guiRenShenSha = formatted.shenSha?.filter(s => s.name.includes('贵人') || s.name.includes('天乙') || s.name.includes('文昌')) || [];
                const tianYiGuiRen = formatted.shenSha?.find(s => s.name === '天乙贵人');
                noblemanAnalysis.innerHTML = `
                    <p><strong>贵人类型：</strong>${tianYiGuiRen ? '命带天乙贵人，一生多贵人相助，逢凶化吉' : guiRenShenSha.length > 0 ? '命带' + guiRenShenSha.map(s => s.name).join('、') : '贵人运一般，需主动结交益友'}</p>
                    <p style="margin-top: 10px;"><strong>贵人方位：</strong>${usefulGods.length > 0 ? usefulGods.map(g => elementDirections[g.element]).filter((v, i, a) => a.indexOf(v) === i).join('、') : '宜多往喜用方向发展，易得贵人'}</p>
                    <p style="margin-top: 10px;"><strong>建议：</strong>${guiRenShenSha.length > 0 ? '多参加社交活动，珍惜贵人缘分' : '主动拓展人脉，善待身边人'}</p>
                `;
                
                // 5. 大运流年综合评分
                const daYunScore = document.getElementById('da-yun-score');
                const daYunStages = formatted.daYun?.stages || [];
                const liuNianList = formatted.liuNian || [];
                const avgDaYunScore = daYunStages.length > 0 ? Math.round(daYunStages.reduce((sum, s) => sum + (s.score || 60), 0) / daYunStages.length) : 60;
                const avgLiuNianScore = liuNianList.length > 0 ? Math.round(liuNianList.slice(0, 3).reduce((sum, n) => sum + (n.score || 60), 0) / Math.min(3, liuNianList.length)) : 60;
                daYunScore.innerHTML = `
                    <p><strong>大运综合评分：</strong><span style="font-size: 24px; color: ${avgDaYunScore >= 70 ? '#2ecc71' : avgDaYunScore >= 50 ? '#f39c12' : '#e74c3c'};">${avgDaYunScore}分</span> (${avgDaYunScore >= 70 ? '运势较好' : avgDaYunScore >= 50 ? '运势中等' : '运势偏弱'})</p>
                    <p style="margin-top: 10px;"><strong>流年综合评分：</strong><span style="font-size: 24px; color: ${avgLiuNianScore >= 70 ? '#2ecc71' : avgLiuNianScore >= 50 ? '#f39c12' : '#e74c3c'};">${avgLiuNianScore}分</span> (${avgLiuNianScore >= 70 ? '流年顺利' : avgLiuNianScore >= 50 ? '流年平稳' : '需谨慎应对'})</p>
                    <p style="margin-top: 10px;"><strong>综合建议：</strong>${avgDaYunScore >= 70 && avgLiuNianScore >= 70 ? '大运流年皆佳，是发展事业、开拓进取的好时机' : avgDaYunScore >= 50 && avgLiuNianScore >= 50 ? '运势平稳，宜稳扎稳打，积累实力' : '运势偏弱，宜保守经营，避免冒险'}</p>
                `;
                
                // 命理分析总评分
                try {
                    // 1. 综合评分
                    const totalScoreText = formatted.summary?.totalScore || '0/100';
                    const totalScore = parseInt(totalScoreText.split('/')[0]) || 0;
                    document.getElementById('overall-score').textContent = totalScore;
                    
                    let overallGrade = '';
                    if (totalScore >= 90) overallGrade = '上等';
                    else if (totalScore >= 80) overallGrade = '中上';
                    else if (totalScore >= 70) overallGrade = '中等';
                    else if (totalScore >= 60) overallGrade = '中下';
                    else overallGrade = '偏弱';
                    document.getElementById('overall-grade').textContent = overallGrade;
                    
                    // 2. 格局评分
                    const patternLevel = formatted.patternAnalysis?.level;
                    const patternScore = patternLevel?.score || 0;
                    document.getElementById('pattern-score').textContent = patternScore;
                    document.getElementById('pattern-grade').textContent = patternLevel?.level || '普通';
                    
                    // 3. 平衡指数
                    const balanceIndex = formatted.elementBalance?.balanceIndex || 0;
                    document.getElementById('balance-index').textContent = balanceIndex + '%';
                    
                    let balanceGrade = '';
                    if (balanceIndex >= 80) balanceGrade = '优秀';
                    else if (balanceIndex >= 60) balanceGrade = '良好';
                    else if (balanceIndex >= 40) balanceGrade = '一般';
                    else balanceGrade = '偏弱';
                    document.getElementById('balance-grade').textContent = balanceGrade;
                    
                    // 4. 神煞评分
                    const shenShaList = formatted.shenSha || [];
                    let shenShaScore = 10; // 基础分
                    shenShaList.forEach(sha => {
                        if (sha.type === '吉') shenShaScore += 5;
                        else if (sha.type === '凶') shenShaScore -= 3;
                        else shenShaScore += 1;
                    });
                    shenShaScore = Math.max(0, Math.min(20, shenShaScore));
                    document.getElementById('shen-sha-score').textContent = shenShaScore;
                    
                    let shenShaGrade = '';
                    if (shenShaScore >= 15) shenShaGrade = '吉多';
                    else if (shenShaScore >= 10) shenShaGrade = '平衡';
                    else shenShaGrade = '凶多';
                    document.getElementById('shen-sha-grade').textContent = shenShaGrade;
                    
                } catch (scoreError) {
                    console.error('渲染总评分时出错:', scoreError);
                }
                
            } catch (error) {
                console.error('渲染综合建议时出错:', error);
            }
        }
        
        // 大运建议生成函数
        function getDaYunAdvice(stage) {
            const adviceMap = {
                '正官': '利于事业发展，适合争取职位、提升名誉，做事有章法，易得上级赏识',
                '七杀': '压力较大，但也是机遇，适合开拓、攻坚，需注意健康，避免过度劳累',
                '正财': '财运稳定，适合积累财富、稳健投资，正财收入增加，宜踏实工作',
                '偏财': '偏财运佳，适合投资、创业，易得意外之财，但也需防破财',
                '正印': '学习运佳，适合进修、考证，贵人相助，思维清晰，易获知识成果',
                '偏印': '适合研究、技术工作，但需注意人际关系，思维独特，易有创新',
                '食神': '才华展现，适合艺术、创作，生活安逸，享受生活，人际关系和谐',
                '伤官': '才华横溢，但易有是非，需注意言行，适合发挥特长，但需低调',
                '比肩': '合作机会多，但竞争也激烈，朋友相助，但也需防朋友夺财',
                '劫财': '易有破财，需注意理财，避免借贷，合作需谨慎，防人算计'
            };
            
            return adviceMap[stage.tenGod] || '运势平稳，稳扎稳打，把握机遇，注意规避风险';
        }
        
        // 流年建议生成函数
        function getLiuNianAdvice(nian) {
            const adviceMap = {
                '正官': '事业运佳，易有提升机会，宜积极表现，争取荣誉',
                '七杀': '压力与机遇并存，需勇敢面对挑战，注意身体健康',
                '正财': '正财运旺，宜努力工作，稳定求财，避免投机',
                '偏财': '偏财机会多，可适当投资，但需见好就收',
                '正印': '学习运佳，易得贵人相助，适合进修提升',
                '偏印': '思维活跃，适合研究创新，但需注意人际关系',
                '食神': '才华得以展现，生活安逸，适合享受生活',
                '伤官': '需注意言行，避免口舌是非，发挥才华但需低调',
                '比肩': '朋友相助，合作机会多，但也竞争激烈',
                '劫财': '需注意理财，避免借贷，合作需谨慎'
            };
            
            const baseAdvice = adviceMap[nian.tenGod] || '运势平稳，宜稳扎稳打';
            
            if (nian.chongHe && nian.chongHe.includes('冲')) {
                return `${baseAdvice}。流年有冲，变动较大，宜主动求变，不宜固守。`;
            } else if (nian.chongHe && nian.chongHe.includes('合')) {
                return `${baseAdvice}。流年有合，运势和顺，宜把握合作机会。`;
            } else {
                return `${baseAdvice}。流年平稳，宜按计划行事，积累实力。`;
            }
        }
        
        // 渲染紫微扩展分析
        function renderZiweiExtendedAnalysis(extendedResult, rawBazi) {
            try {
                console.log('开始渲染紫微扩展分析...', extendedResult);
                
                // 1. 优化吉凶评分
                const fortuneScore = extendedResult.优化吉凶评分;
                if (fortuneScore) {
                    console.log('渲染优化吉凶评分:', fortuneScore);
                    
                    // 分项评分
                    const elementScore = fortuneScore.分项评分?.五行平衡 || 0;
                    const patternScore = fortuneScore.分项评分?.格局分析 || 0;
                    const shenshaScore = fortuneScore.分项评分?.神煞吉凶 || 0;
                    const starScore = fortuneScore.分项评分?.星曜组合 || 0;
                    const palaceScore = fortuneScore.分项评分?.宫位四化 || 0;
                    const totalScore = fortuneScore.总评分 || 0;
                    
                    document.getElementById('ziwei-element-score').textContent = elementScore;
                    document.getElementById('ziwei-pattern-score').textContent = patternScore;
                    document.getElementById('ziwei-shensha-score').textContent = shenshaScore;
                    document.getElementById('ziwei-star-score').textContent = starScore;
                    document.getElementById('ziwei-palace-score').textContent = palaceScore;
                    document.getElementById('ziwei-total-score').textContent = totalScore.toFixed(1);
                    document.getElementById('ziwei-fortune-level').textContent = fortuneScore.吉凶等级 || '-';
                    document.getElementById('ziwei-core-conclusion').textContent = fortuneScore.核心结论 || '';
                }
                
                // 2. 星曜组合分析
                const starCombination = extendedResult.星曜组合分析;
                if (starCombination) {
                    console.log('渲染星曜组合分析:', starCombination);
                    
                    // 三方四正
                    const sanfangContent = document.getElementById('sanfang-sizheng-content');
                    let sanfangHtml = '';
                    if (starCombination['三方四正']) {
                        Object.entries(starCombination['三方四正']).forEach(([pillar, data]) => {
                            sanfangHtml += `<div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">`;
                            sanfangHtml += `<strong style="color: #3498db;">${pillar}</strong><br>`;
                            sanfangHtml += `<span style="font-size: 12px; color: #7f8c8d;">三方: ${data.三方?.join('、') || '无'}</span><br>`;
                            sanfangHtml += `<span style="font-size: 12px; color: #7f8c8d;">四正: ${data.四正?.join('、') || '无'}</span><br>`;
                            sanfangHtml += `<span style="font-size: 12px; color: #e74c3c;">相冲: ${data.相冲?.join('、') || '无'}</span>`;
                            sanfangHtml += `</div>`;
                        });
                    }
                    sanfangContent.innerHTML = sanfangHtml || '<p style="color: #7f8c8d;">无三方四正数据</p>';
                    
                    // 星曜克制
                    const restraintContent = document.getElementById('star-restraint-content');
                    let restraintHtml = '';
                    if (starCombination['星曜克制'] && starCombination['星曜克制'].length > 0) {
                        starCombination['星曜克制'].forEach((item) => {
                            restraintHtml += `<div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">`;
                            restraintHtml += `<strong>主星: ${item.主星}</strong><br>`;
                            if (item.克制的星曜 && item.克制的星曜.length > 0) {
                                restraintHtml += `<span style="color: #e74c3c; font-size: 13px;">→ 克制: ${item.克制的星曜.join('、')}</span><br>`;
                            }
                            if (item.被克制的星曜 && item.被克制的星曜.length > 0) {
                                restraintHtml += `<span style="color: #2ecc71; font-size: 13px;">→ 被克: ${item.被克制的星曜.join('、')}</span>`;
                            }
                            restraintHtml += `</div>`;
                        });
                    }
                    restraintContent.innerHTML = restraintHtml || '<p style="color: #7f8c8d;">无明显克制关系</p>';
                    
                    // 关键会照
                    const keyCombContent = document.getElementById('key-combination-content');
                    let keyHtml = '';
                    if (starCombination['关键会照']) {
                        const keyCombs = starCombination['关键会照'];
                        keyHtml += `<div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">`;
                        keyHtml += `<strong style="color: #f39c12;">桃花驿马会照</strong><br>`;
                        keyHtml += `<span style="font-size: 13px; color: #34495e;">${keyCombs['桃花驿马'] ? '✓ 桃花驿马同时出现，主奔波走动、异性缘佳' : '✗ 桃花驿马未同时出现'}</span>`;
                        keyHtml += `</div>`;
                        keyHtml += `<div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">`;
                        keyHtml += `<strong style="color: #9b59b6;">将星华盖会照</strong><br>`;
                        keyHtml += `<span style="font-size: 13px; color: #34495e;">${keyCombs['将星华盖'] ? '✓ 将星华盖同时出现，主领导才能、才华横溢' : '✗ 将星华盖未同时出现'}</span>`;
                        keyHtml += `</div>`;
                    }
                    keyCombContent.innerHTML = keyHtml || '<p style="color: #7f8c8d;">无关键会照组合</p>';
                }
                
                // 3. 宫位分析
                const palaceAnalysis = extendedResult.宫位分析;
                if (palaceAnalysis) {
                    console.log('渲染宫位分析:', palaceAnalysis);
                    
                    // 命宫信息
                    const lifePalaceInfo = document.getElementById('life-palace-info');
                    if (palaceAnalysis.命宫) {
                        lifePalaceInfo.innerHTML = `
                            <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #3498db;">${palaceAnalysis.命宫.地支}</div>
                                <div style="color: #7f8c8d; font-size: 12px;">命宫地支</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${palaceAnalysis.命宫.纳音 || '未知'}</div>
                                <div style="color: #7f8c8d; font-size: 12px;">命宫纳音</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${palaceAnalysis.命宫.五行}</div>
                                <div style="color: #7f8c8d; font-size: 12px;">命宫五行</div>
                            </div>
                        `;
                    }
                    
                    // 各宫位四化表格
                    const palaceTableBody = document.getElementById('palace-sihua-tbody');
                    let tableHtml = '';
                    if (palaceAnalysis.各宫位四化) {
                        Object.entries(palaceAnalysis.各宫位四化).forEach(([palaceName, data]) => {
                            const sihua = data.四化;
                            const elementRatio = data.五行占比;
                            
                            tableHtml += `<tr>`;
                            tableHtml += `<td style="padding: 10px; text-align: center; font-weight: bold;">${palaceName}</td>`;
                            tableHtml += `<td style="padding: 10px; text-align: center;">${data.宫位地支}</td>`;
                            tableHtml += `<td style="padding: 10px; text-align: center;">${sihua.禄?.是否得化 ? '<span style="color: #2ecc71; font-weight: bold;">✓</span>' : '<span style="color: #95a5a6;">-</span>'}</td>`;
                            tableHtml += `<td style="padding: 10px; text-align: center;">${sihua.权?.是否得化 ? '<span style="color: #3498db; font-weight: bold;">✓</span>' : '<span style="color: #95a5a6;">-</span>'}</td>`;
                            tableHtml += `<td style="padding: 10px; text-align: center;">${sihua.科?.是否得化 ? '<span style="color: #f39c12; font-weight: bold;">✓</span>' : '<span style="color: #95a5a6;">-</span>'}</td>`;
                            tableHtml += `<td style="padding: 10px; text-align: center;">${sihua.忌?.是否得化 ? '<span style="color: #e74c3c; font-weight: bold;">✓</span>' : '<span style="color: #95a5a6;">-</span>'}</td>`;
                            
                            // 五行占比
                            let ratioHtml = '<div style="font-size: 11px;">';
                            if (elementRatio) {
                                Object.entries(elementRatio).forEach(([element, ratio]) => {
                                    ratioHtml += `<span style="margin-right: 8px;">${element}:${ratio}</span>`;
                                });
                            }
                            ratioHtml += '</div>';
                            tableHtml += `<td style="padding: 10px; text-align: left;">${ratioHtml}</td>`;
                            tableHtml += `</tr>`;
                        });
                    }
                    palaceTableBody.innerHTML = tableHtml || '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">无宫位数据</td></tr>';
                    
                    // 宫位解读
                    const palaceInterpretation = document.getElementById('palace-interpretation');
                    let interpHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
                    if (palaceAnalysis.各宫位四化) {
                        Object.entries(palaceAnalysis.各宫位四化).forEach(([palaceName, data]) => {
                            const sihua = data.四化;
                            let sihuaDesc = [];
                            if (sihua.禄?.是否得化) sihuaDesc.push('<span style="color: #2ecc71;">禄</span>');
                            if (sihua.权?.是否得化) sihuaDesc.push('<span style="color: #3498db;">权</span>');
                            if (sihua.科?.是否得化) sihuaDesc.push('<span style="color: #f39c12;">科</span>');
                            if (sihua.忌?.是否得化) sihuaDesc.push('<span style="color: #e74c3c;">忌</span>');
                            
                            interpHtml += `
                                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <strong style="color: #2c3e50;">${palaceName} (${data.宫位地支})</strong>
                                    <div style="margin-top: 8px; font-size: 13px; color: #7f8c8d;">
                                        四化: ${sihuaDesc.length > 0 ? sihuaDesc.join('、') : '无'}
                                    </div>
                                </div>
                            `;
                        });
                    }
                    interpHtml += '</div>';
                    palaceInterpretation.innerHTML = interpHtml;
                }
                
                // 4. 详细分析建议
                const detailedAnalysis = document.getElementById('ziwei-detailed-analysis');
                let analysisHtml = '';
                
                if (fortuneScore) {
                    analysisHtml += `<div style="margin-bottom: 20px;">`;
                    analysisHtml += `<h4 style="color: #9b59b6; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> 评分体系说明</h4>`;
                    analysisHtml += `<p>本评分系统采用多维度加权算法，从五行平衡、格局分析、神煞吉凶、星曜组合、宫位四化五个维度综合评价命局。</p>`;
                    analysisHtml += `<ul style="margin-top: 10px; padding-left: 20px;">`;
                    analysisHtml += `<li><strong>五行平衡 (30分):</strong> 评估八字五行分布的均衡性，越平衡得分越高</li>`;
                    analysisHtml += `<li><strong>格局分析 (25分):</strong> 根据命局格局类型和等级评分，特殊格局加分</li>`;
                    analysisHtml += `<li><strong>神煞吉凶 (20分):</strong> 统计吉神凶煞的影响力，吉神加分、凶神扣分</li>`;
                    analysisHtml += `<li><strong>星曜组合 (15分):</strong> 评估三方四正、星曜会照等组合，吉利组合加分</li>`;
                    analysisHtml += `<li><strong>宫位四化 (10分):</strong> 分析十二宫位的四化情况，禄权科加分、忌扣分</li>`;
                    analysisHtml += `</ul>`;
                    analysisHtml += `</div>`;
                }
                
                if (starCombination) {
                    analysisHtml += `<div style="margin-bottom: 20px;">`;
                    analysisHtml += `<h4 style="color: #9b59b6; margin-bottom: 10px;"><i class="fas fa-star"></i> 星曜组合解读</h4>`;
                    analysisHtml += `<p><strong>三方：</strong>地支三合局（申子辰、寅午戌、亥卯未、巳酉丑），主贵人相助、事势顺遂。</p>`;
                    analysisHtml += `<p><strong>四正：</strong>四桃花位（子、午、卯、酉），主魄力、行动力、异性缘。</p>`;
                    analysisHtml += `<p><strong>星曜克制：</strong>反映五行生克制化关系，克者为压制，被克者为受制。</p>`;
                    analysisHtml += `<p><strong>关键会照：</strong>桃花+驿马主奔波走动、异性缘；将星+华盖主领导才能、才华出众。</p>`;
                    analysisHtml += `</div>`;
                }
                
                if (palaceAnalysis) {
                    analysisHtml += `<div style="margin-bottom: 20px;">`;
                    analysisHtml += `<h4 style="color: #9b59b6; margin-bottom: 10px;"><i class="fas fa-compass"></i> 宫位体系解读</h4>`;
                    analysisHtml += `<p><strong>命宫：</strong>代表本命、核心性格、先天格局。</p>`;
                    analysisHtml += `<p><strong>四化：</strong>禄主财运福分，权主权力掌控，科主智慧名声，忌主阻碍损耗。</p>`;
                    analysisHtml += `<p><strong>财帛宫：</strong>代表财运、物质积累、理财能力。</p>`;
                    analysisHtml += `<p><strong>事业宫：</strong>代表事业、社会地位、职场发展。</p>`;
                    analysisHtml += `<p><strong>夫妻宫：</strong>代表婚姻、伴侣、感情关系。</p>`;
                    analysisHtml += `</div>`;
                }
                
                detailedAnalysis.innerHTML = analysisHtml;
                console.log('紫微扩展分析渲染完成');
                
            } catch (error) {
                console.error('渲染紫微扩展分析时出错:', error);
            }
        }
    </script>
</body>
</html>
